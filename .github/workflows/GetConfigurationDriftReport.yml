
name: Call Configuration Drift Web API

on:
  workflow_dispatch:

jobs:
  call-api:
    name: POST to Configuration Drift API
    runs-on: ubuntu-latest

    # Map environment variables from GitHub Secrets (ensure exact secret names exist)
    env:
      # Non-secret-like values (but still stored as secrets for convenience)
      AUTO_REMEDIATION: ${{ secrets.AUTO_REMEDIATION }}           # "true"/"false"
      MANUAL_REMEDIATION: ${{ secrets.MANUAL_REMEDIATION }}       # "true"/"false"
      CITRIX_CLOUD_ID: ${{ secrets.CITRIX_CLOUD_ID }}
      CITRIX_INSTANCE_ID: ${{ secrets.CITRIX_INSTANCE_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      MAIL_FROM: ${{ secrets.MAIL_FROM }}
      MAIL_TO: ${{ secrets.MAIL_TO }}
      USE_CONFIGURATION_LOGGING: ${{ secrets.USE_CONFIGURATION_LOGGING }}   # "true"/"false"
      NOTIFICATION_PER_EMAIL: ${{ secrets.NOTIFICATION_PER_EMAIL }}         # "true"/"false"

      # Sensitive secrets
      API_URL: ${{ secrets.CONFIG_DRIFT_API_URL }}              # e.g., https://host/api/configuration-drift
      API_BEARER_TOKEN: ${{ secrets.CONFIG_DRIFT_API_TOKEN }}   # optional
      CITRIX_CLOUD_API_SECRET: ${{ secrets.CITRIX_CLOUD_API_SECRET }}
      CITRIX_CLOUD_API_KEY: ${{ secrets.CITRIX_CLOUD_API_KEY }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

      # Optional: set to "true" to allow -k with curl for dev/self-signed
      INSECURE_TLS: ${{ secrets.INSECURE_TLS }}

    steps:
      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for var in API_URL CITRIX_CLOUD_API_SECRET CITRIX_CLOUD_API_KEY AZURE_CLIENT_SECRET CITRIX_CLOUD_ID CITRIX_INSTANCE_ID AZURE_TENANT_ID AZURE_CLIENT_ID MAIL_FROM MAIL_TO; do
            if [ -z "${!var:-}" ]; then
              echo "::error::Missing required secret/env: $var"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Build JSON payload safely with jq
        shell: bash
        run: |
          set -euo pipefail

          # Normalize booleans (secrets come as strings)
          to_bool () { [[ "${1:-}" == "true" || "${1:-}" == "True" || "${1:-}" == "1" ]] && echo true || echo false; }

          AUTO="$(to_bool "${AUTO_REMEDIATION:-false}")"
          MANUAL="$(to_bool "${MANUAL_REMEDIATION:-false}")"
          UCL="$(to_bool "${USE_CONFIGURATION_LOGGING:-true}")"
          NOTI="$(to_bool "${NOTIFICATION_PER_EMAIL:-true}")"

          # Build JSON with jq to avoid quoting/escaping issues
          jq -n \
            --arg CitrixCloudID            "$CITRIX_CLOUD_ID" \
            --arg CitrixCloudAPISecret     "$CITRIX_CLOUD_API_SECRET" \
            --arg CitrixCloudAPIKey        "$CITRIX_CLOUD_API_KEY" \
            --arg CitrixInstanceID         "$CITRIX_INSTANCE_ID" \
            --arg AzureTenantId            "$AZURE_TENANT_ID" \
            --arg AzureClientId            "$AZURE_CLIENT_ID" \
            --arg AzureClientSecret        "$AZURE_CLIENT_SECRET" \
            --arg MailFrom                 "$MAIL_FROM" \
            --arg MailTo                   "$MAIL_TO" \
            --argjson AutomaticRemediation "$AUTO" \
            --argjson ManualRemediation    "$MANUAL" \
            --argjson UseConfigurationLogging "$UCL" \
            --argjson NotificationPerEMail "$NOTI" \
            '{
              AutomaticRemediation: $AutomaticRemediation,
              ManualRemediation: $ManualRemediation,
              CitrixCloudID: $CitrixCloudID,
              CitrixCloudAPISecret: $CitrixCloudAPISecret,
              CitrixCloudAPIKey: $CitrixCloudAPIKey,
              CitrixInstanceID: $CitrixInstanceID,
              AzureTenantId: $AzureTenantId,
              AzureClientId: $AzureClientId,
              AzureClientSecret: $AzureClientSecret,
              MailFrom: $MailFrom,
              MailTo: $MailTo,
              UseConfigurationLogging: $UseConfigurationLogging,
              NotificationPerEMail: $NotificationPerEMail
            }' > payload.json

          echo "Built payload.json (redacted preview):"
          sed -E \
            -e 's/("CitrixCloudAPISecret": ")[^"]+/\1***REDACTED***"/' \
            -e 's/("AzureClientSecret": ")[^"]+/\1***REDACTED***"/' \
            -e 's/("CitrixCloudAPIKey": ")[^"]+/\1***REDACTED***"/' \
            payload.json

      - name: POST using curl (with retry)
        id: post_curl
        shell: bash
        run: |
          set -euo pipefail

          TLS_OPT=""
          if [[ "${INSECURE_TLS:-false}" == "true" ]]; then
            echo "WARNING: INSECURE_TLS=true => using curl -k (dev only)"
            TLS_OPT="-k"
          fi

          AUTH=()
          if [ -n "${API_BEARER_TOKEN:-}" ]; then
            AUTH=(-H "Authorization: Bearer ${API_BEARER_TOKEN}")
          fi

          curl ${TLS_OPT} -sS -X POST "${API_URL}" \
            -H "Content-Type: application/json" \
            "${AUTH[@]}" \
            --retry 3 --retry-delay 3 \
            --fail \
            --data-binary @payload.json \
            -o response.json

          echo "API responded with (redacted):"
          sed -E \
            -e 's/("[A-Za-z0-9_]*Secret":\s*")[^"]+/\1***REDACTED***"/g' \
            response.json || true

      - name: Upload response artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-response
          path: response.json
          if-no-files-found: warn

      # Optional: Defense-in-depth if you ever switch to pull_request triggers
      # - name: Guard against forks
      #   if: ${{ github.event.pull_request.head.repo.fork == true }}
      #   run: |
      #     echo "Fork detected â€“ refusing to run with secrets"
      #     exit 1
